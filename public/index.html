<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARAOCHAOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Space+Grotesk:wght@300;700&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --neon-pink: #ff00ff; --neon-green: #39ff14; --neon-blue: #00f2ff; --neon-red: #ff3131; --dark-bg: #050505; }
        body { font-family: 'Space Grotesk', sans-serif; background-color: var(--dark-bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; text-transform: uppercase; }
        #display-box { font-family: 'Syncopate', sans-serif; background: #000; border: 8px solid var(--neon-green); border-radius: 80px; box-shadow: 0 0 40px var(--neon-green), inset 0 0 20px var(--neon-green); height: 400px; width: 1000px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 40px auto; padding: 40px; box-sizing: border-box; color: var(--neon-green); text-align: center; }
        #song-display-text { font-size: 3.5rem; text-shadow: 0 0 20px var(--neon-green); }
        .artist-style { display: block; font-family: 'Space Grotesk'; font-size: 2rem; color: var(--neon-blue); margin-top: 25px; }
        #scoreboard { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.9); border: 3px solid var(--neon-pink); padding: 20px; border-radius: 30px; width: 320px; z-index: 100; }
        #round-indicator { color: var(--neon-blue); font-family: 'Syncopate'; font-size: 1.1rem; text-align: center; margin-bottom: 10px; border-bottom: 2px solid var(--neon-blue); padding-bottom: 5px; }
        .btn { padding: 20px 40px; font-size: 1.2rem; cursor: pointer; border: none; border-radius: 60px; margin: 10px; font-weight: 700; font-family: 'Syncopate'; }
        .btn-green { background: var(--neon-green); color: black; box-shadow: 0 0 20px var(--neon-green); }
        .btn-pink { background: var(--neon-pink); color: white; }
        .btn-red { background: var(--neon-red); color: white; }
        #voting-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .timer-container { position: relative; width: 450px; height: 450px; display: flex; align-items: center; justify-content: center; }
        .timer-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
        .timer-bg { fill: none; stroke: #222; stroke-width: 6; }
        #timer-bar { fill: none; stroke: var(--neon-green); stroke-width: 6; stroke-linecap: round; stroke-dasharray: 283; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }
        #v-timer { font-size: 10rem; font-family: 'Syncopate'; color: var(--neon-green); position: relative; z-index: 10; }
        #v-count { font-size: 3rem; color: var(--neon-blue); font-family: 'Syncopate'; margin-top: 20px; }
        .qr-fixed-bottom { position: fixed; bottom: 40px; left: 40px; background: white; padding: 10px; border-radius: 15px; z-index: 3000; }
        #next-up-footer { margin-top: 50px; font-family: 'Syncopate'; padding: 20px; border: 3px solid var(--neon-blue); border-radius: 20px; background: rgba(0,0,0,0.6); }
        .hidden { display: none !important; }
        #current-player-display { font-family: 'Syncopate'; font-size: 3.5rem; color: var(--neon-pink); text-align: center; margin-bottom: 20px; }
        .setup-input { padding: 15px; font-size: 1.2rem; border-radius: 15px; border: 2px solid var(--neon-blue); background: #000; color: #fff; margin: 10px; text-align: center; }
    </style>
</head>
<body>
    <div id="voting-overlay" class="hidden">
        <div class="timer-container">
            <svg class="timer-svg" viewBox="0 0 100 100">
                <circle class="timer-bg" cx="50" cy="50" r="45"></circle>
                <circle id="timer-bar" cx="50" cy="50" r="45"></circle>
            </svg>
            <div id="v-timer">25</div>
        </div>
        <div id="v-count">VOTES: 0</div>
        <div id="next-up-footer">
            <span style="color: var(--neon-blue);">NEXT UP: </span>
            <span id="next-player-name" style="color: white; font-size: 2rem;">---</span>
        </div>
        <div class="qr-fixed-bottom"><canvas id="canvas-overlay"></canvas></div>
    </div>
    <div id="scoreboard" class="hidden"><div id="round-indicator">ROUND 1 / 3</div><div id="score-list"></div></div>
    <div id="setup-screen" style="text-align: center;">
        <h1 style="color: var(--neon-pink); font-family: 'Syncopate'; font-size: 4rem;">KARAOCHAOS</h1>
        <div style="margin-bottom: 20px;"><canvas id="canvas-setup" style="background:white; padding:10px; border-radius:15px;"></canvas></div>
        <input type="text" id="player-names" class="setup-input" placeholder="NAMES (ALICE, BOB...)" style="width: 450px;"><br>
        <button class="btn btn-green" onclick="startGame()">START SESSION</button>
    </div>
    <div id="game-screen" class="hidden">
        <div id="current-player-display">READY?</div>
        <div id="display-box"><div id="song-display-text">PUSH SELECT</div></div>
        <div style="text-align: center;">
            <div id="spin-group"><button class="btn btn-green" onclick="animateSelection()">SELECT SONG</button></div>
            <div id="action-btns" class="hidden">
                <button class="btn btn-green" onclick="playSong()">I'VE GOT THIS!</button>
                <button id="skip-btn-el" class="btn btn-pink" onclick="skipSong()">SKIP (-1 PT)</button>
            </div>
            <div id="result-btns" class="hidden">
                <button class="btn btn-red" onclick="startVoting(5)">QUITTER (5 PTS)</button>
                <button class="btn btn-green" onclick="startVoting(10)">NAILED IT! (10 PTS)</button>
            </div>
        </div>
    </div>
    <script>
        const socket = io();
        let masterSongs = [], players = [], activeDeck = [], currentPlayerIndex = 0, currentRound = 1, targetSong = null;

        socket.emit('request-init');
        socket.on('init-data', (data) => {
            masterSongs = data.songs;
            const shareUrl = window.location.origin + '/mobile';
            QRCode.toCanvas(document.getElementById('canvas-setup'), shareUrl, { width: 160 });
            QRCode.toCanvas(document.getElementById('canvas-overlay'), shareUrl, { width: 120 });
        });

        function startGame() {
            const names = document.getElementById('player-names').value;
            if(!names) return;
            players = names.split(',').map(n => ({ name: n.trim(), score: 0 }));
            activeDeck = [...masterSongs].sort(() => Math.random() - 0.5);
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('scoreboard').classList.remove('hidden');
            updatePlayerTurnUI();
            updateUI();
        }

        function animateSelection() {
            document.getElementById('spin-group').classList.add('hidden');
            document.getElementById('action-btns').classList.add('hidden');
            let spins = 0;
            const interval = setInterval(() => {
                const temp = masterSongs[Math.floor(Math.random() * masterSongs.length)];
                document.getElementById('song-display-text').innerText = temp.title;
                if (++spins >= 20) { clearInterval(interval); finalizeSelection(); }
            }, 100);
        }

        function finalizeSelection() {
            if (activeDeck.length === 0) activeDeck = [...masterSongs].sort(() => Math.random() - 0.5);
            targetSong = activeDeck.pop();
            const parts = targetSong.title.split(' - ');
            document.getElementById('song-display-text').innerHTML = `${parts[0]}<span class="artist-style">${parts[1] || ''}</span>`;
            document.getElementById('action-btns').classList.remove('hidden');
        }

        function playSong() { window.open(targetSong.url, '_blank'); document.getElementById('action-btns').classList.add('hidden'); document.getElementById('result-btns').classList.remove('hidden'); }
        function skipSong() { players[currentPlayerIndex].score -= 1; updateUI(); animateSelection(); }

        function startVoting(basePts) { 
            players[currentPlayerIndex].score += basePts; 
            document.getElementById('result-btns').classList.add('hidden'); 
            document.getElementById('voting-overlay').classList.remove('hidden'); 
            socket.emit('start-voting'); 
        }

        socket.on('timer-update', (t) => {
            document.getElementById('v-timer').innerText = t;
            const offset = 283 - (t / 25) * 283;
            document.getElementById('timer-bar').style.strokeDashoffset = offset;
        });

        socket.on('count-update', (c) => document.getElementById('v-count').innerText = `VOTES: ${c}`);
        socket.on('voting-end', (bonus) => {
            players[currentPlayerIndex].score += bonus;
            document.getElementById('voting-overlay').classList.add('hidden');
            nextTurn();
        });

        function nextTurn() {
            currentPlayerIndex++;
            if (currentPlayerIndex >= players.length) { currentPlayerIndex = 0; currentRound++; }
            document.getElementById('spin-group').classList.remove('hidden');
            document.getElementById('song-display-text').innerText = "PUSH SELECT";
            updatePlayerTurnUI();
            updateUI();
        }

        function updatePlayerTurnUI() {
            const p = players[currentPlayerIndex];
            const nextP = players[(currentPlayerIndex + 1) % players.length];
            document.getElementById('current-player-display').innerText = `UP NEXT: ${p.name}`;
            document.getElementById('next-player-name').innerText = nextP.name;
        }

        function updateUI() {
            document.getElementById('round-indicator').innerText = `ROUND ${currentRound}`;
            document.getElementById('score-list').innerHTML = players.map(p => `
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #333; font-family:'Syncopate'; font-size:0.8rem;">
                    <span>${p.name}</span><span>${p.score} PTS</span>
                </div>`).join('');
        }
    </script>
</body>
</html>