<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARAOCHAOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Space+Grotesk:wght@300;700&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --neon-pink: #ff00ff; --neon-green: #39ff14; --neon-blue: #00f2ff; --neon-red: #ff3131; --dark-bg: #050505; }
        body { font-family: 'Space Grotesk', sans-serif; background-color: var(--dark-bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; text-transform: uppercase; }
        
        /* Setup & Management */
        #setup-screen h1 { font-family: 'Syncopate'; font-size: 7rem; color: var(--neon-pink); margin-bottom: 30px; text-shadow: 0 0 30px var(--neon-pink); }
        #player-names { padding: 25px; width: 700px; font-size: 2rem; border-radius: 20px; border: 4px solid var(--neon-blue); background: #000; color: #fff; text-align: center; margin-bottom: 20px; }
        .setup-qr-container { position: fixed; bottom: 30px; left: 30px; background: white; padding: 12px; border-radius: 10px; }

        #manage-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111; border: 4px solid var(--neon-blue); padding: 30px; width: 80%; height: 80%; overflow-y: auto; z-index: 10000; border-radius: 20px; }
        .song-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; font-family: 'Space Grotesk'; align-items: center; }
        .toggle-btn { padding: 8px 20px; cursor: pointer; border-radius: 5px; border: none; font-family: 'Syncopate'; font-size: 0.8rem; font-weight: bold; }
        .toggle-on { background: var(--neon-green); color: black; }
        .toggle-off { background: #444; color: white; }

        /* Add Song Form Styling */
        .add-song-form { background: #000; padding: 20px; border-radius: 15px; border: 1px solid #333; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .add-song-form input[type="text"] { background: #111; border: 1px solid var(--neon-blue); color: white; padding: 10px; border-radius: 5px; flex: 1; min-width: 200px; }
        .add-song-form label { font-size: 0.8rem; font-family: 'Syncopate'; color: var(--neon-pink); display: flex; align-items: center; gap: 5px; cursor: pointer; }

        /* Game Elements */
        #current-player-display { font-family: 'Syncopate'; font-size: 2.2rem; color: var(--neon-pink); margin-bottom: 15px; text-align: center; line-height: 1.1; }
        .performer-name { display: block; font-size: 4.8rem; color: white; text-shadow: 0 0 20px var(--neon-pink); margin-top: 10px; }
        #display-box { font-family: 'Syncopate', sans-serif; background: #000; border: 6px solid var(--neon-green); border-radius: 60px; box-shadow: 0 0 30px var(--neon-green), inset 0 0 15px var(--neon-green); height: 300px; width: 850px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 30px; padding: 30px; box-sizing: border-box; color: var(--neon-green); text-align: center; }
        #song-display-text { font-size: 2.2rem; }

        /* Scoring & Feedback */
        #scoreboard { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.9); border: 3px solid var(--neon-pink); padding: 20px; border-radius: 30px; width: 260px; z-index: 100; }
        #points-splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; z-index: 6000; pointer-events: none; }
        .splash-text { font-family: 'Syncopate'; font-size: 6rem; color: var(--neon-green); text-shadow: 0 0 40px var(--neon-green); animation: splashMove 1.8s ease-out forwards; text-align: center; line-height: 1.2; }
        @keyframes splashMove { 0% { transform: scale(0.5) translateY(50px); opacity: 0; } 20% { transform: scale(1.1) translateY(0); opacity: 1; } 100% { transform: scale(0.9) translateY(-150px); opacity: 0; } }

        /* Layout & UI */
        .btn { padding: 20px 40px; font-size: 1.2rem; cursor: pointer; border: none; border-radius: 60px; margin: 10px; font-weight: 700; font-family: 'Syncopate'; }
        .btn-green { background: var(--neon-green); color: black; box-shadow: 0 0 20px var(--neon-green); }
        .btn-pink { background: var(--neon-pink); color: white; }
        .btn-red { background: var(--neon-red); color: white; }
        #voting-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="points-splash"></div>

    <div id="manage-modal" class="hidden">
        <h2 style="font-family:'Syncopate'; color:var(--neon-blue);">SONG MANAGEMENT</h2>
        
        <div class="add-song-form">
            <input type="text" id="new-song-title" placeholder="ARTIST - TITLE">
            <input type="text" id="new-song-url" placeholder="YOUTUBE URL">
            <label><input type="checkbox" id="new-song-duet"> DUET</label>
            <label><input type="checkbox" id="new-song-unskippable"> UNSKIPPABLE</label>
            <button class="toggle-btn toggle-on" onclick="addSong()">ADD</button>
        </div>

        <div id="song-list-container"></div>
        <button class="btn btn-green" onclick="toggleManageModal(false)" style="margin-top:20px; width:100%;">SAVE & CLOSE</button>
    </div>

    <div id="setup-screen" style="text-align: center;">
        <h1>KARAOCHAOS</h1>
        <div class="setup-qr-container"><canvas id="canvas-setup"></canvas></div>
        <div style="display:flex; flex-direction:column; align-items:center; gap:15px;">
            <input type="text" id="player-names" placeholder="NAMES (ALICE, BOB...)">
            <div style="color:var(--neon-pink); font-family:'Syncopate';">ROUNDS: <input type="number" id="round-count" value="3" style="width:80px; padding:10px; background:#000; border:2px solid var(--neon-pink); color:#fff; text-align:center;"></div>
            <div style="display:flex;">
                <button class="btn btn-pink" onclick="toggleManageModal(true)">MANAGE SONGS</button>
                <button class="btn btn-green" onclick="startGame()">START GAME</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div id="current-player-display">NOW PERFORMING:<br><span class="performer-name">---</span></div>
        <div id="display-box"><div id="song-display-text">PUSH SELECT</div></div>
        <div id="next-player-preview" class="hidden" style="position:fixed; bottom:40px; right:40px; font-family:'Syncopate'; text-align:right;">UP NEXT: <span id="next-name-val" style="color:var(--neon-blue); display:block; font-size:1.8rem;">---</span></div>
        <div style="text-align: center;">
            <div id="spin-group"><button class="btn btn-green" onclick="animateSelection()">SELECT SONG</button></div>
            <div id="action-btns" class="hidden">
                <button class="btn btn-green" onclick="playSong()">I'VE GOT THIS</button>
                <button class="btn btn-pink" onclick="skipSong()">SKIP (-1)</button>
            </div>
            <div id="result-btns" class="hidden">
                <button class="btn btn-red" onclick="handleResult(5, false)">QUITTER</button>
                <button class="btn btn-green" onclick="handleResult(10, true)">NAILED IT!</button>
            </div>
            <div id="game-over-btns" class="hidden"><button class="btn btn-green" onclick="location.reload()">START OVER</button></div>
        </div>
    </div>

    <div id="voting-overlay" class="hidden">
        <div style="position:relative; width:280px; height:280px; display:flex; align-items:center; justify-content:center;">
            <svg style="position:absolute; width:100%; height:100%; transform:rotate(-90deg);" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="none" stroke="#222" stroke-width="6"></circle>
                <circle id="timer-bar" cx="50" cy="50" r="45" fill="none" stroke="var(--neon-green)" stroke-width="6" stroke-dasharray="283" stroke-dashoffset="0" style="transition:1s linear;"></circle>
            </svg>
            <div id="v-timer" style="font-size:7rem; color:var(--neon-green); font-family:'Syncopate';">25</div>
        </div>
        <div id="v-count" style="font-size:2rem; color:var(--neon-blue); margin-top:20px;">VOTES: 0</div>
    </div>

    <div id="scoreboard" class="hidden"><div id="round-indicator" style="text-align: center; border-bottom: 1px solid var(--neon-blue); margin-bottom:10px;">ROUND 1</div><div id="score-list"></div></div>

    <script>
        const socket = io();
        let masterSongs = [], players = [], activeDeck = [], currentPlayerIndex = 0, currentRound = 1, maxRounds = 3, targetSong = null, skipsThisTurn = 0;
        let isVoteActiveLocal = false; 

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSelectionSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(400 + Math.random() * 800, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.04, audioCtx.currentTime);
            gain.gain.setValueAtTime(0, audioCtx.currentTime + 0.05);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.05);
        }

        socket.on('init-data', (data) => {
            masterSongs = data.songs;
            QRCode.toCanvas(document.getElementById('canvas-setup'), window.location.origin + '/mobile', { width: 120 });
        });
        socket.emit('request-init');

        function toggleManageModal(show) {
            const modal = document.getElementById('manage-modal');
            if (show) { modal.classList.remove('hidden'); renderSongManager(); }
            else { modal.classList.add('hidden'); }
        }

        function renderSongManager() {
            const container = document.getElementById('song-list-container');
            container.innerHTML = masterSongs.map((song, index) => `
                <div class="song-item">
                    <span>${song.title}</span>
                    <button class="toggle-btn ${song.active !== false ? 'toggle-on' : 'toggle-off'}" onclick="toggleSong(${index})">
                        ${song.active !== false ? 'ACTIVE' : 'INACTIVE'}
                    </button>
                </div>`).join('');
        }

        function toggleSong(index) {
            masterSongs[index].active = (masterSongs[index].active === false) ? true : false;
            renderSongManager();
        }

        function addSong() {
            const title = document.getElementById('new-song-title').value;
            const url = document.getElementById('new-song-url').value;
            const isDuet = document.getElementById('new-song-duet').checked;
            const isUnskippable = document.getElementById('new-song-unskippable').checked;

            if(!title || !url) return;

            const newSong = {
                title: title,
                url: url,
                duet: isDuet,
                unskippable: isUnskippable,
                active: true
            };

            masterSongs.push(newSong);
            socket.emit('add-song-to-file', newSong);

            // Reset fields
            document.getElementById('new-song-title').value = "";
            document.getElementById('new-song-url').value = "";
            document.getElementById('new-song-duet').checked = false;
            document.getElementById('new-song-unskippable').checked = false;
            
            renderSongManager();
        }

        function startGame() {
            const n = document.getElementById('player-names').value;
            if(!n) return;
            const names = n.split(',').map(s => s.trim()).filter(s => s !== "");
            players = names.map(name => ({ name: name, score: 0 }));
            maxRounds = parseInt(document.getElementById('round-count').value) || 3;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('scoreboard').classList.remove('hidden');
            updateUI();
        }

        function animateSelection() {
            const list = masterSongs.filter(s => s.active !== false);
            if (list.length === 0) { alert("NO ACTIVE SONGS!"); return; }
            document.getElementById('spin-group').classList.add('hidden');
            let count = 0;
            const int = setInterval(() => {
                const r = list[Math.floor(Math.random() * list.length)];
                document.getElementById('song-display-text').innerText = r.title;
                playSelectionSound();
                if(++count > 15) { clearInterval(int); finalizeSelection(list); }
            }, 100);
        }

        function finalizeSelection(list) {
            if(activeDeck.length === 0) activeDeck = [...list].sort(() => Math.random() - 0.5);
            targetSong = activeDeck.pop();
            const parts = targetSong.title.split(' - ');
            document.getElementById('song-display-text').innerHTML = parts.length > 1 ? `${parts[0]}<br><span style="font-size:1.4rem; color:var(--neon-blue);">${parts[1]}</span>` : targetSong.title;
            document.getElementById('action-btns').classList.remove('hidden');
            socket.emit('update-performance', { singer: players[currentPlayerIndex].name, song: targetSong.title });
        }

        function playSong() { window.open(targetSong.url, '_blank'); document.getElementById('action-btns').classList.add('hidden'); document.getElementById('result-btns').classList.remove('hidden'); }
        
        function skipSong() {
            skipsThisTurn++;
            players[currentPlayerIndex].score -= 1;
            const splash = document.getElementById('points-splash');
            splash.style.display = 'flex';
            if (skipsThisTurn >= 3) {
                players[currentPlayerIndex].score -= 2; // Total -3
                splash.innerHTML = `<div class="splash-text" style="color:var(--neon-red); text-shadow:0 0 30px var(--neon-red);">FORFEIT!<br>-3 POINTS</div>`;
                setTimeout(() => { splash.style.display = 'none'; proceed(); }, 2000);
            } else {
                splash.innerHTML = `<div class="splash-text" style="color:var(--neon-red); text-shadow:0 0 30px var(--neon-red);">-1 POINT</div>`;
                setTimeout(() => { splash.style.display = 'none'; updateUI(); animateSelection(); }, 1000);
            }
        }

        function handleResult(pts, triggerVote) {
            players[currentPlayerIndex].score += pts;
            const splash = document.getElementById('points-splash');
            splash.style.display = 'flex';
            
            if (triggerVote) {
                isVoteActiveLocal = true;
                splash.innerHTML = `<div class="splash-text">NICELY DONE!<br>+10 POINTS</div>`;
                socket.emit('start-voting');
                document.getElementById('next-player-preview').classList.remove('hidden');
                document.getElementById('voting-overlay').classList.remove('hidden');
                setTimeout(() => { splash.style.display = 'none'; }, 2000);
            } else {
                isVoteActiveLocal = false;
                socket.emit('cancel-voting'); 
                splash.innerHTML = `<div class="splash-text">+5 POINTS FOR TRYING!</div>`;
                setTimeout(() => { splash.style.display = 'none'; proceed(); }, 2500);
            }
        }

        socket.on('timer-update', (t) => {
            document.getElementById('v-timer').innerText = t;
            document.getElementById('timer-bar').style.strokeDashoffset = 283 - (t/25)*283;
        });
        socket.on('count-update', (c) => document.getElementById('v-count').innerText = `VOTES: ${c}`);
        
        socket.on('voting-end', (bonus) => {
            document.getElementById('voting-overlay').classList.add('hidden');
            if (isVoteActiveLocal) {
                players[currentPlayerIndex].score += bonus;
                const splash = document.getElementById('points-splash');
                splash.style.display = 'flex';
                splash.innerHTML = `<div class="splash-text">+${bonus} BONUS!</div>`;
                if(bonus > 2) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                setTimeout(() => { splash.style.display = 'none'; proceed(); }, 2000);
                isVoteActiveLocal = false;
            }
        });

        function proceed() {
            skipsThisTurn = 0;
            currentPlayerIndex++;
            if(currentPlayerIndex >= players.length) { currentPlayerIndex = 0; currentRound++; }
            document.getElementById('result-btns').classList.add('hidden');
            document.getElementById('next-player-preview').classList.add('hidden');
            if(currentRound > maxRounds) {
                document.getElementById('current-player-display').innerHTML = `WINNER:<br><span class="performer-name">${[...players].sort((a,b)=>b.score-a.score)[0].name}</span>`;
                document.getElementById('game-over-btns').classList.remove('hidden');
                document.getElementById('song-display-text').innerText = "FINALE";
            } else {
                document.getElementById('spin-group').classList.remove('hidden');
                document.getElementById('song-display-text').innerText = "PUSH SELECT";
            }
            updateUI();
            socket.emit('update-performance', { singer: "", song: "" });
        }

        function updateUI() {
            document.getElementById('round-indicator').innerText = `ROUND ${currentRound} OF ${maxRounds}`;
            document.getElementById('score-list').innerHTML = players.map(p => `<div style="display:flex; justify-content:space-between; margin:5px 0;"><span>${p.name}</span><span>${p.score}</span></div>`).join('');
            if(currentRound <= maxRounds) {
                document.getElementById('current-player-display').innerHTML = `NOW PERFORMING:<br><span class="performer-name">${players[currentPlayerIndex].name}</span>`;
                let nIdx = (currentPlayerIndex + 1) % players.length;
                document.getElementById('next-name-val').innerText = (currentRound === maxRounds && nIdx === 0) ? "GAME OVER" : players[nIdx].name;
            }
        }
    </script>
</body>
</html>
